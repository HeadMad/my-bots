# Дорожная Карта Проекта "BotHub"

Этот документ описывает план разработки платформы BotHub, основываясь на [Техническом Задании](TECHNICAL_SPECIFICATION.md). План разбит на ключевые этапы (Milestones) для итеративной разработки.

---

## Milestone 1: Аутентификация и Управление Пользователями (Pure JS)

**Цель:** Создать базовую инфраструктуру для регистрации и входа пользователей, используя только нативные возможности фреймворка и JS.

- [x] **1.1. Настройка Базы Данных:**
    - [x] Инициализировать Cloudflare D1 и финализировать схемы таблиц (`users`, `sessions`, `user_identities` и т.д. из `src/lib/server/schemas.js`).
    - [x] Написать/адаптировать скрипт для инициализации схемы в D1 (`src/hooks.server.js` создан).
- [ ] **1.2. Реализация Аутентификации (Master-Bot Flow with SSE):**
    - [ ] **Backend (SSE Infrastructure):**
        - [x] Создать `LoginSession` Durable Object для управления SSE-соединениями (`src/lib/server/LoginSession.js`).
        - [x] Добавить биндинг `LOGIN_SESSION` в `wrangler.jsonc` и экспортировать класс в `entry.js`.
        - [x] Создать API-эндпоинт (`/api/auth/login`) для генерации `auth_token` и `hash`.
        - [x] Создать API-эндпоинт (`/api/auth/events`) для подключения фронтенда к `LoginSession` DO по SSE.
        - [x] **Интеграция с вебхуком:** В обработчике вебхука мастер-бота (`/api/webhook/master/telegram/[hash]`) добавлена логика для уведомления `LoginSession` DO после успешного логина.
        - [x] Создать API-эндпоинт (`/api/auth/session`), который после получения подтверждения через SSE будет создавать сессию в таблице `sessions` и устанавливать `httpOnly` cookie с ID сессии.
    - [ ] **Frontend (SSE):**
        - [ ] Установить библиотеку для QR-кодов (например, `qrcode`).
        - [ ] На странице входа разместить кнопку "Войти через Telegram".
        - [ ] По клику вызывать `/api/auth/login` для получения `hash`.
        - [ ] Отображать ссылку `t.me/YourMasterBot?start=<hash>` и сгенерированный QR-код для нее.
        - [ ] Подписываться на SSE-эндпоинт (`/api/auth/events/[hash]`).
        - [ ] При получении сообщения по SSE, вызывать `/api/auth/session` для создания сессии и перенаправления в личный кабинет.
- [ ] **1.3. Управление Сессиями (Pure JS):**
    - [ ] **Server Hook (`src/hooks.server.js`):**
        - [ ] Реализовать `handle`, который будет на каждом запросе читать cookie.
        - [ ] Валидировать ID сессии из cookie в таблице `sessions`.
        - [ ] Если сессия валидна, получать `user` и добавлять его в `event.locals.user`.
        - [ ] Если сессия невалидна, `event.locals.user` должен быть `null`.
    - [ ] **Выход из системы (Logout):**
        - [ ] Создать эндпоинт `/api/auth/logout`, который удаляет сессию из БД и очищает cookie.
- [ ] **1.4. Защита Роутов и Профиль Пользователя:**
    - [ ] Создать страницу профиля, доступную только аутентифицированным пользователям (проверка `event.locals.user`).
    - [ ] Настроить редиректы для защищенных страниц, если пользователь не залогинен.

---

## Milestone 2: Управление Ботами

**Цель:** Дать пользователям возможность добавлять своих ботов на платформу и управлять ими.

- [ ] **2.1. Интерфейс для Добавления Бота:**
    - [ ] Создать страницу/раздел в личном кабинете с формой для ввода токена Telegram-бота.
- [ ] **2.2. Логика на Бекенде:**
    - [ ] Реализовать API-эндпоинт для добавления бота.
    - [ ] **Валидация токена:** При получении токена делать запрос к API Telegram (`getMe`) для проверки его валидности.
    - [ ] **Шифрование:** Зашифровать токен бота перед сохранением в базу данных.
    - [ ] Сохранить информацию о боте (ID, name, username, зашифрованный токен) в таблице `bots`.
- [ ] **2.3. Настройка Вебхука:**
    - [ ] Создать механизм для автоматической установки вебхука для бота. URL должен быть вида `https://<your-domain>/api/webhook/<bot_id>`.
    - [ ] Использовать API Telegram (`setWebhook`) для регистрации нашего эндпоинта.
- [ ] **2.4. Отображение Списка Ботов:**
    - [ ] В личном кабинете отображать список всех ботов, добавленных пользователем.
    - [ ] По каждому боту показывать его имя, username и статус (например, "Активен" если вебхук успешно установлен).

---

## Milestone 3: Прием и Хранение Сообщений

**Цель:** Наладить процесс приема входящих сообщений от ботов и их корректное сохранение.

- [ ] **3.1. Реализация Вебхук-Хендлера:**
    - [ ] Создать глобальный API роут `src/routes/api/webhook/[...path]/+server.js`.
    - [ ] Реализовать логику, которая будет парсить входящие `Update` от Telegram.
    - [ ] Идентифицировать бота, к которому относится сообщение.
- [ ] **3.2. Сохранение данных в БД:**
    - [ ] При получении сообщения, проверять, существует ли чат в таблице `chats`. Если нет - создавать новую запись.
    - [ ] Сохранять каждое новое сообщение в таблицу `messages`, связывая его с ботом и чатом.
    - [ ] Обрабатывать разные типы чатов (private, group, channel).

---

## Milestone 4: Интерфейс Чатов и Отправка Сообщений

**Цель:** Создать полноценный интерфейс для просмотра чатов и ведения переписки от имени бота.

- [ ] **4.1. Создание UI для Чатов:**
    - [ ] Разработать основной лейаут: слева - список чатов для выбранного бота, справа - область с сообщениями.
    - [ ] Реализовать роутинг вида `/bots/[botId]/chat/[chatId]`.
    - [ ] Загружать и отображать историю сообщений для выбранного чата из БД.
- [ ] **4.2. Real-time Обновления:**
    - [ ] Интегрировать существующую реализацию на Durable Objects (WebSocket) с новым интерфейсом.
    - [ ] После сохранения нового сообщения в БД (из Milestone 3), инициировать событие, которое отправит это сообщение всем подключенным клиентам в реальном времени.
- [ ] **4.3. Отправка Сообщений:**
    - [ ] Добавить в интерфейс поле для ввода текста и кнопку "Отправить".
    - [ ] Создать API-эндпоинт для отправки сообщения.
    - [ ] В этом эндпоинте:
        - Получить из БД расшифрованный токен бота.
        - Сделать запрос к API Telegram (`sendMessage`) для отправки сообщения в нужный чат.
        - Сохранить отправленное сообщение в своей БД.
        - Инициировать real-time событие для отображения отправленного сообщения у клиента.

---

## Milestone 5: Улучшения и Дополнительный Функционал

**Цель:** Повысить качество и удобство использования платформы.

- [ ] **5.1. Поддержка Разного Контента:**
    - [ ] Отображение изображений, документов и других вложений в чате.
    - [ ] Возможность отправки не только текста, но и других медиа.
- [ ] **5.2. Улучшение UI/UX:**
    - [ ] Добавить индикаторы загрузки, статусы сообщений (доставлено, прочитано - если API позволяет).
    - [ ] Отполировать дизайн, сделать его адаптивным.
- [ ] **5.3. Обработка Ошибок и Логирование:**
    - [ ] Внедрить систему логирования для отладки проблем с вебхуками и API.
    - [ ] Отображать пользователю понятные ошибки (например, если токен стал недействительным).
- [ ] **5.4. Главная (Лендинговая) страница:**
    - [ ] Создать привлекательную главную страницу с описанием проекта, согласно ТЗ.

---
