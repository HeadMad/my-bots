# Техническое Задание: Платформа Управления Ботами "BotHub"

## 1. Обзор Системы

**Название проекта:** BotHub (рабочее название)

**Цель:** Создать многоплатформенную PaaS (Platform as a Service) для централизованного управления чат-ботами. Платформа позволит пользователям регистрировать своих ботов, подключать их к различным мессенджерам, настраивать базовый функционал и управлять перепиской через единый веб-интерфейс.

**Технологический стек:**
- **Фреймворк:** SvelteKit
- **UI:** Svelte 5
- **Хостинг/Бекенд:** Cloudflare Workers (Serverless)
- **База данных:** Cloudflare D1 или другая serverless-совместимая БД (например, Turso)
- **Аутентификация:** Lucia-auth (или аналог), интеграция с OAuth провайдерами платформ (Telegram, etc.)

**Целевая аудитория:**
- Владельцы малого и среднего бизнеса, использующие ботов для коммуникации с клиентами.
- Независимые разработчики и энтузиасты.
- Маркетинговые и SMM агентства.

## 2. Функциональные Требования

### 2.1. Главная (Лендинговая) страница
- **Содержание:**
    - Ясное и привлекательное описание преимуществ платформы.
    - Ключевые функции (управление перепиской, мультиплатформенность, аналитика).
    - Призыв к действию (Call-to-Action): кнопка "Начать" или "Зарегистрироваться".
    - Возможно, секция с тарифами (на будущее).

### 2.2. Управление Аккаунтом и Аутентификация
- **Регистрация/Вход:**
    - Реализовать через master-bot той платформы на которой будут добавляться боты (на старте - Telegram)
    - При первой аутентификации через соц.сеть автоматически создавать аккаунт пользователя.
- **Профиль пользователя:**
    - Внутренний профиль пользователя, к которому привязываются внешние аккаунты.
    - Пользователь должен иметь возможность привязать несколько аккаунтов (например, Telegram, позже - Discord, Slack) к одному профилю BotHub.
    - Отображение привязанных аккаунтов и возможность их отвязки.

### 2.3. Управление Ботами
- **Добавление нового бота:**
    - Интерфейс для добавления бота путем предоставления его токена (API key).
    - **Валидация токена:** Система должна проверять валидность токена через API платформы (например, `getMe` для Telegram).
    - **Безопасность:** Токены ботов должны храниться в базе данных в зашифрованном виде.
- **Настройка вебхука (Webhook):**
    - После успешного добавления бота система должна автоматически или по кнопке "Активировать" устанавливать вебхук для бота.
    - URL вебхука должен быть уникальным для каждого бота (например, `https://bothub.app/webhook/<bot_token_hash>`). Это обеспечит безопасность и правильную маршрутизацию запросов.
    - Существующий роут `src/routes/webhook/[botToken]/+server.js` будет использован как основа для этого механизма.
- **Список ботов:**
    - В личном кабинете должен отображаться список всех добавленных пользователем ботов с их статусами (активен/неактивен).

### 2.4. Интерфейс Чатов (Основной функционал)
- **Агрегация переписок:**
    - Система должна принимать входящие сообщения от ботов через вебхук и сохранять их в базу данных.
    - **Структура БД:** Должны быть таблицы для `Users`, `Bots`, `Chats`, `Messages`.
    - Поддерживать разные типы чатов: личные сообщения, группы, каналы, бизнес-аккаунты (для Telegram).
- **Веб-интерфейс для чатов:**
    - Создать интерфейс в стиле мессенджера (`/dashboard/bot/<bot_id>/chat/<chat_id>`).
    - Слева - список чатов для выбранного бота.
    - Справа - история сообщений в выбранном чате.
    - **Real-time обновления:** Новые сообщения должны появляться в интерфейсе без перезагрузки страницы (использовать Server-Sent Events (SSE) или WebSockets).
- **Ответ от имени бота:**
    - В интерфейсе чата должно быть поле для ввода текста и кнопка "Отправить".
    - При отправке система должна использовать сохраненный токен бота для отправки сообщения получателю через API платформы (например, `sendMessage` для Telegram).
- **Поддержка контента:**
    - На первом этапе - обработка и отображение текстовых сообщений.
    - В последующих версиях - поддержка изображений, файлов, стикеров.

## 3. Нефункциональные Требования

- **Безопасность:**
    - Шифрование чувствительных данных (токены ботов).
    - Защита от CSRF, XSS атак.
    - Валидация всех входящих данных.
- **Производительность:**
    - Быстрая загрузка интерфейса и отклик чата. Архитектура на Cloudflare Workers способствует низкой задержке.
- **Масштабируемость:**
    - Архитектура должна быть готова к увеличению количества ботов, пользователей и сообщений. Выбор serverless-технологий этому способствует.
- **Надежность:**
    - Система должна быть отказоустойчивой. Обеспечить логирование ошибок и мониторинг состояния воркеров.

## 4. Архитектура высокого уровня

1.  **Frontend (SvelteKit):** Пользовательский интерфейс, личный кабинет, дашборд управления ботами и чатами. Статические страницы рендерятся на Edge, динамические - с помощью воркеров.
2.  **Backend (Cloudflare Workers):**
    - **API Endpoints:** Роуты для аутентификации, управления ботами (добавление/удаление), отправки сообщений.
    - **Webhook Handler:** Основной воркер (`/webhook/[...slug]`), принимающий, валидирующий и обрабатывающий входящие данные от платформ (Telegram и др.). Он же сохраняет сообщения в БД и инициирует real-time обновление для фронтенда.
3.  **Database (Cloudflare D1):** Хранение информации о пользователях, ботах (включая зашифрованные токены), чатах, сообщениях и связях между ними.
4.  **Внешние сервисы (API Мессенджеров):** Взаимодействие с API Telegram (и других платформ в будущем) для установки вебхуков, отправки сообщений и валидации токенов.
